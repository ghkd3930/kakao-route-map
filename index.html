 <!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- ✅ Kakao Maps JS SDK (autoload=false로 안정화) -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f50dc2a44d1f4e5431f0c50eebe87c19&libraries=services"></script>

<style>
  html, body { width:100%; height:100%; margin:0; padding:0; }
  #map { width:100%; height:100%; }

  /* 번호 아이콘 */
  .marker{
    background:#d60000; color:#fff;
    width:34px; height:34px; border-radius:50%;
    text-align:center; line-height:34px;
    font-weight:700; font-size:16px;
    box-shadow:0 2px 6px rgba(0,0,0,.3);
    cursor:pointer;

    /* 모바일 터치 안정 */
    pointer-events:auto;
    touch-action:manipulation;
    user-select:none;
  }

  .toast{
    position:fixed; left:12px; right:12px; bottom:12px;
    background:rgba(0,0,0,.78); color:#fff;
    padding:10px 12px; border-radius:10px;
    font-size:13px; line-height:1.4;
    z-index:999999;
  }
</style>
</head>

<body>
  <div id="map"></div>
  <div id="toast" class="toast" style="display:none;"></div>

<script>
/**
 * ✅ 한 링크에서 시트 바꿔끼우기
 *   ?sid=스프레드시트ID&sheet=탭이름&orderCol=순서&addrCol=주소
 * 예)
 *   /kakao-route-map/?sheet=오늘동선
 *   /kakao-route-map/?sid=다른ID&sheet=Sheet1
 *   /kakao-route-map/?orderCol=번호&addrCol=주소지
 */
const params = new URLSearchParams(location.search);

// 기본값(너가 준 시트)
const DEFAULT_SID   = "1lvmKmQeich7vLiMkDFX9qd1_E5890ATQ33UDcvArMsg";
const DEFAULT_SHEET = "Sheet1";

// 기본 컬럼명
const DEFAULT_ORDER_COL = "순서";
const DEFAULT_ADDR_COL  = "주소";

const sid      = params.get("sid")      || DEFAULT_SID;
const sheet    = params.get("sheet")    || DEFAULT_SHEET;
const orderCol = params.get("orderCol") || DEFAULT_ORDER_COL;
const addrCol  = params.get("addrCol")  || DEFAULT_ADDR_COL;

const toast = (msg) => {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.style.display = "block";
};

/** ✅ 길찾기 열기: 인앱브라우저/딥링크 문제 회피 위해 "웹 길찾기"를 확실히 연다 */
function openKakaoWebRoute(name, lat, lng){
  const webUrl = `https://map.kakao.com/link/to/${encodeURIComponent(name)},${lat},${lng}`;

  // 사용자 클릭 제스처 안에서 새탭 열기 시도 (성공률 높음)
  const w = window.open(webUrl, "_blank");

  // 팝업 차단이면 같은 탭 이동
  if (!w) location.href = webUrl;
}

async function loadSheet(){
  toast(`불러오는 중… (sid=${sid}, sheet=${sheet})`);
  const url = `https://opensheet.elk.sh/${encodeURIComponent(sid)}/${encodeURIComponent(sheet)}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`시트 불러오기 실패: HTTP ${res.status}`);
  return await res.json();
}

function geocode(geocoder, address){
  return new Promise((resolve) => {
    geocoder.addressSearch(address, (result, status) => {
      if(status === kakao.maps.services.Status.OK && result?.[0]){
        resolve({ ok:true, lat:Number(result[0].y), lng:Number(result[0].x) });
      } else {
        resolve({ ok:false });
      }
    });
  });
}

kakao.maps.load(async () => {
  // ✅ 지도 생성
  const map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(35.1595,126.8514),
    level: 5
  });

  // ✅ 검은 화면 방지
  setTimeout(() => { map.relayout(); map.setCenter(map.getCenter()); }, 300);

  const geocoder = new kakao.maps.services.Geocoder();
  const overlays = [];

  function clearOverlays(){
    while(overlays.length){
      const ov = overlays.pop();
      ov.setMap(null);
    }
  }

  /**
   * ✅ 가장 안정적인 클릭 방식:
   * - 번호는 CustomOverlay(HTML)로 보여주되
   * - 클릭은 overlay div에 직접 걸고
   * - 클릭 시 window.open(웹 길찾기)로 확실히 연다
   */
  function addMarker(index, address, lat, lng){
    const coords = new kakao.maps.LatLng(lat, lng);

    // (1) 지도에 기본 마커(위치용) — 선택사항이지만 안정 위해 유지
    const marker = new kakao.maps.Marker({ position: coords });
    marker.setMap(map);

    // (2) 번호 표시용 오버레이 (DOM element로 만들어서 이벤트 확실히 걸기)
    const el = document.createElement("div");
    el.className = "marker";
    el.title = address;
    el.textContent = index;

    const overlay = new kakao.maps.CustomOverlay({
      position: coords,
      content: el,
      yAnchor: 1,
      zIndex: 9999
    });
    overlay.setMap(map);
    overlays.push(overlay);

    // ✅ 클릭/터치 이벤트
    const handler = (e) => {
      e.preventDefault();
      e.stopPropagation();
      toast(`열기: ${index}`);
      openKakaoWebRoute(String(index), lat, lng);
    };

    el.addEventListener("click", handler, { passive: false });
    el.addEventListener("touchend", handler, { passive: false });

    // 마커 클릭도 동일 동작(혹시 오버레이 클릭이 막히는 환경 대비)
    kakao.maps.event.addListener(marker, "click", function(){
      toast(`열기: ${index}`);
      openKakaoWebRoute(String(index), lat, lng);
    });
  }

  try{
    const data = await loadSheet();
    clearOverlays();

    // 정렬(숫자)
    data.sort((a,b)=> Number(a[orderCol]) - Number(b[orderCol]));

    let bounds = new kakao.maps.LatLngBounds();
    let okCount = 0;
    let failCount = 0;

    for(const row of data){
      const index = row[orderCol];
      const address = row[addrCol];
      if(index == null || !address) continue;

      const g = await geocode(geocoder, address);
      if(!g.ok){ failCount++; continue; }

      okCount++;
      addMarker(index, address, g.lat, g.lng);
      bounds.extend(new kakao.maps.LatLng(g.lat, g.lng));
    }

    if(okCount > 0){
      map.setBounds(bounds);
      toast(`완료 ✅ 표시 ${okCount}개 (지오코딩 실패 ${failCount}개)`);
    } else {
      toast(`표시할 좌표가 없어요. 컬럼명/주소 확인 (orderCol=${orderCol}, addrCol=${addrCol})`);
    }
  }catch(e){
    toast(`에러: ${e.message}`);
  }
});
</script>
</body>
</html>
