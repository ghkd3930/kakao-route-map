<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f50dc2a44d1f4e5431f0c50eebe87c19&libraries=services&autoload=false"></script>

<style>
  html, body { width:100%; height:100%; margin:0; padding:0; }
  #map { width:100%; height:100%; }

  .marker{
    background:#d60000; color:#fff;
    width:34px; height:34px; border-radius:50%;
    text-align:center; line-height:34px;
    font-weight:700; font-size:16px;
    box-shadow:0 2px 6px rgba(0,0,0,.3);
    cursor:pointer;
    pointer-events:auto;
    touch-action:manipulation;
    user-select:none;
    position:relative;
    z-index:9999;
  }

  .me-dot{
    width:14px; height:14px; border-radius:50%;
    background:#2d7ff9;
    box-shadow:0 0 0 6px rgba(45,127,249,0.25);
    border:2px solid #fff;
  }

  .toast{
    position:fixed; left:12px; right:12px; bottom:12px;
    background:rgba(0,0,0,.78); color:#fff;
    padding:10px 12px; border-radius:10px;
    font-size:13px; line-height:1.4;
    z-index:999999;
    display:none;
  }

  .controls{
    position:fixed; top:12px; right:12px;
    z-index:999999;
    display:flex; gap:8px;
  }
  .btn{
    border:0;
    padding:10px 12px;
    border-radius:10px;
    background:rgba(0,0,0,.78);
    color:#fff;
    font-size:13px;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active{ transform: translateY(1px); }
</style>
</head>

<body>
  <div id="map"></div>

  <div class="controls">
    <button class="btn" id="btnFollow">따라가기: ON</button>
    <button class="btn" id="btnMyLoc">내 위치</button>
  </div>

  <div id="toast" class="toast"></div>

<script>
const params = new URLSearchParams(location.search);
const DEFAULT_SID   = "1lvmKmQeich7vLiMkDFX9qd1_E5890ATQ33UDcvArMsg";
const DEFAULT_SHEET = "Sheet1";
const DEFAULT_ORDER_COL = "순서";
const DEFAULT_ADDR_COL  = "주소";

const sid      = params.get("sid")      || DEFAULT_SID;
const sheet    = params.get("sheet")    || DEFAULT_SHEET;
const orderCol = params.get("orderCol") || DEFAULT_ORDER_COL;
const addrCol  = params.get("addrCol")  || DEFAULT_ADDR_COL;

const toastEl = document.getElementById("toast");
function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
}

function openKakaoWebRoute(name, lat, lng){
  const webUrl = `https://map.kakao.com/link/to/${encodeURIComponent(name)},${lat},${lng}`;
  const w = window.open(webUrl, "_blank");
  if (!w) location.href = webUrl;
}

async function loadSheet(){
  toast(`불러오는 중… (sid=${sid}, sheet=${sheet})`);
  const url = `https://opensheet.elk.sh/${encodeURIComponent(sid)}/${encodeURIComponent(sheet)}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`시트 불러오기 실패: HTTP ${res.status}`);
  return await res.json();
}

kakao.maps.load(async () => {
  const map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(35.1595,126.8514),
    level: 5
  });
  setTimeout(() => { map.relayout(); map.setCenter(map.getCenter()); }, 300);

  const geocoder = new kakao.maps.services.Geocoder();

  // ===== 마커(항상 표시) =====
  const overlays = [];
  function clearOverlays(){ while(overlays.length) overlays.pop().setMap(null); }

  function addMarker(index, address, lat, lng){
    const coords = new kakao.maps.LatLng(lat, lng);

    const el = document.createElement("div");
    el.className = "marker";
    el.title = address;
    el.textContent = index;

    const overlay = new kakao.maps.CustomOverlay({
      position: coords,
      content: el,
      yAnchor: 1,
      zIndex: 9999
    });

    overlay.setMap(map);
    overlays.push(overlay);

    const handler = (e) => {
      e.preventDefault();
      e.stopPropagation();
      openKakaoWebRoute(String(index), lat, lng);
    };
    el.addEventListener("click", handler, { passive:false });
    el.addEventListener("touchend", handler, { passive:false });
  }

  function geocode(address){
    return new Promise((resolve) => {
      geocoder.addressSearch(address, (result, status) => {
        if(status === kakao.maps.services.Status.OK && result?.[0]){
          resolve({ ok:true, lat:Number(result[0].y), lng:Number(result[0].x) });
        } else resolve({ ok:false });
      });
    });
  }

  // ===== 내 위치 + 따라가기 =====
  let myPosOverlay = null;
  let myAccCircle = null;
  let watchId = null;

  let followMe = true;
  const AUTO_REFOLLOW_MS = 5000;

  let isDragging = false;       // ✅ 드래그 중 여부
  let refollowTimer = null;

  const btnFollow = document.getElementById("btnFollow");
  function updateFollowButton(){
    btnFollow.textContent = `따라가기: ${followMe ? "ON" : "OFF"}`;
  }
  updateFollowButton();

  function clearRefollowTimer(){
    if(refollowTimer){ clearTimeout(refollowTimer); refollowTimer = null; }
  }

  function scheduleAutoRefollow(){
    // ✅ "드래그가 끝난 뒤"에만 예약되도록 밖에서 호출(중요)
    clearRefollowTimer();
    refollowTimer = setTimeout(() => {
      // 드래그 중이면 다시 미룸
      if(isDragging){
        scheduleAutoRefollow();
        return;
      }
      followMe = true;
      updateFollowButton();
      panToMyLocation(true);
    }, AUTO_REFOLLOW_MS);
  }

  btnFollow.onclick = () => {
    followMe = !followMe;
    updateFollowButton();
    clearRefollowTimer();
    if(followMe) panToMyLocation(true);
  };

  document.getElementById("btnMyLoc").onclick = () => {
    followMe = true;
    updateFollowButton();
    clearRefollowTimer();
    panToMyLocation(true);
  };

  function showMyLocation(lat, lng, accuracyMeters){
    const pos = new kakao.maps.LatLng(lat, lng);

    if(!myPosOverlay){
      const el = document.createElement("div");
      el.className = "me-dot";
      myPosOverlay = new kakao.maps.CustomOverlay({
        position: pos,
        content: el,
        yAnchor: 0.5,
        zIndex: 10000
      });
      myPosOverlay.setMap(map);
    } else {
      myPosOverlay.setPosition(pos);
    }

    const r = Math.max(Number(accuracyMeters || 0), 10);
    if(!myAccCircle){
      myAccCircle = new kakao.maps.Circle({
        center: pos,
        radius: r,
        strokeWeight: 2,
        strokeOpacity: 0.7,
        fillOpacity: 0.15
      });
      myAccCircle.setMap(map);
    } else {
      myAccCircle.setPosition(pos);
      myAccCircle.setRadius(r);
    }
  }

  function panToMyLocation(animated){
    if(!myPosOverlay){
      toast("내 위치가 아직 없어요. 권한을 허용해줘요.");
      return;
    }
    const p = myPosOverlay.getPosition();
    if(animated) map.panTo(p);
    else map.setCenter(p);
  }

  function startMyLocationTracking(){
    if(!navigator.geolocation){
      toast("이 브라우저는 위치 기능을 지원하지 않아요.");
      return;
    }
    if(watchId != null) navigator.geolocation.clearWatch(watchId);

    watchId = navigator.geolocation.watchPosition(
      (p) => {
        const { latitude, longitude, accuracy } = p.coords;
        showMyLocation(latitude, longitude, accuracy);

        // ✅ 드래그 중에는 절대 따라가지 않음
        if(followMe && !isDragging){
          map.panTo(new kakao.maps.LatLng(latitude, longitude));
        }
      },
      (err) => toast(`위치 추적 오류: ${err.message}`),
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
    );
  }

  // ✅ 드래그 시작: OFF 유지 + 타이머 취소
  kakao.maps.event.addListener(map, 'dragstart', function(){
    isDragging = true;
    followMe = false;
    updateFollowButton();
    clearRefollowTimer();
  });

  // ✅ 드래그 끝: 그때부터 5초 카운트 시작 → 자동 ON 복귀
  kakao.maps.event.addListener(map, 'dragend', function(){
    isDragging = false;
    scheduleAutoRefollow();
  });

  // ===== 시트 로드 → 마커 전부 표시 =====
  try{
    const data = await loadSheet();
    clearOverlays();

    data.sort((a,b)=> Number(a[orderCol]) - Number(b[orderCol]));

    let okCount = 0, failCount = 0;
    for(const row of data){
      const index = row[orderCol];
      const address = row[addrCol];
      if(index == null || !address) continue;

      const g = await geocode(address);
      if(!g.ok){ failCount++; continue; }

      okCount++;
      addMarker(index, address, g.lat, g.lng);
    }
    toast(`마커 표시됨 ✅ ${okCount}개 (지오코딩 실패 ${failCount}개). 내 위치 중심으로 따라갑니다.`);
  }catch(e){
    toast(`에러: ${e.message}`);
  }

  startMyLocationTracking();
});
</script>
</body>
</html>
